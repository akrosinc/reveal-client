# Android
# Build your Android project with Gradle.
# Add steps that test, sign, and distribute the APK, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/android

trigger:
- main

pool:
  name: Default

steps:
- task: CopyFiles@2
  inputs:
    SourceFolder: '/opt/'
    Contents: 'google-services.json'
    TargetFolder: 'opensrp-reveal'
    OverWrite: true
- task: CopyFiles@2
  inputs:
    SourceFolder: '/opt/'
    Contents: 'local.properties'
    TargetFolder: '.'
    OverWrite: true
- task: Bash@3
  inputs:
    targetType: inline
    script: |
      BUILD_COUNTRY=`(cat opensrp-reveal/build.gradle | grep BUILD_COUNTRY | head -n 1 | awk {'print $4'} | awk -F'.' {'print tolower($6)'} | sed 's/"//'`
      echo "##vso[task.setvariable variable=build_country;]$BUILD_COUNTRY"
- task: Bash@3
  inputs:
    targetType: inline
    script: sed -i 's/BUILD_NUMBER/$(Build.BuildId)/' opensrp-reveal/build.gradle
- task: Bash@3
  inputs:
    targetType: inline
    script: cat opensrp-reveal/build.gradle | grep versionName
- task: Gradle@2
  inputs:
    workingDirectory: ''
    gradleWrapperFile: 'gradlew'
    gradleOptions: '-Xmx3072m'
    publishJUnitResults: false
    testResultsFiles: '**/TEST-*.xml'
    tasks: 'clean build'
    #options: '-x test --debug'
    options: '-x test'
- task: Bash@3
  inputs:
    targetType: inline
    script: jarsigner -keystore /opt/keystore.jks -storepass $(jarsignerKeystorePassword) opensrp-reveal/build/outputs/apk/release/opensrp-reveal-release-unsigned.apk akros.online && /home/fanie/Android/Sdk/build-tools/29.0.3/zipalign 4 opensrp-reveal/build/outputs/apk/release/opensrp-reveal-release-unsigned.apk opensrp-reveal/build/outputs/apk/release/reveal-client-release-$(build_country)-$(Build.BuildId).apk
# - task: CopyFiles@2
#   inputs:
#     contents: '**/*.apk'
#     targetFolder: '$(build.artifactStagingDirectory)'
# - task: PublishBuildArtifacts@1